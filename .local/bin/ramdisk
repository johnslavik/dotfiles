#!/usr/bin/env bash
# Credits to Åukasz Langa -> https://github.com/ambv/.dot_files
# (public domain but deserves an attribution anyway!)

set -CETeuo pipefail

export CPYTHON="$HOME/Python/cpython"
export VSCODE="$HOME/Python/.vscode"
export RAMDISK="/Volumes/RAMDisk"
export WORKTREE="$RAMDISK/cpython"
export BRANCH="${1:-main}"

if test -d "$RAMDISK"; then
    echo "RAM disk already exists at $RAMDISK. Unmount by running:"
    echo
    echo "    hdiutil eject $RAMDISK"
    echo
    exit 1
fi

export SUDO_PROMPT=1
if command sudo -nv 2>/dev/null; then
    # sudo timestamp is fresh before this script ran
    export SUDO_PROMPT=0
else
    echo "This script requires admin privileges to export ownership properly."
    command sudo -v
fi

cd "$CPYTHON"
# git worktree list --porcelain | grep "^worktree $RAMDISK" | gsed -e "s/worktree //" | while read -r stale_worktree; do
#     echo "Stale cpython worktree found in $stale_worktree, deleting."
#     git worktree remove "$stale_worktree"
# done

export DISK_ID

# Allocate 18,874,368 sectors of 512 bytes (~9.7 GB)
DISK_ID="$(
    hdiutil attach -nobrowse -nomount ram://18874368 \
    | sed 's/[[:space:]]*$//'
)"

echo "Creating a RAM disk at $DISK_ID..."
echo -n "Waiting for it to initialize..."

while ! diskutil list "$DISK_ID" >/dev/null 2>/dev/null; do
    echo -n .
    sleep 1
done

echo " done!"

echo "Formatting the RAM disk..."
diskutil erasevolume HFS+ 'RAMDisk' "$DISK_ID"

git worktree add "$WORKTREE" "$BRANCH" -f

sudo diskutil enableOwnership "$DISK_ID"
sudo chown "$USER:staff" "$RAMDISK"
if test "$SUDO_PROMPT" -eq 1; then
    command sudo -k
fi
ln -s "$VSCODE" $WORKTREE/.vscode

echo "All done. Switch to the RAM disk checkout by running:"
echo
echo "    cd $WORKTREE"
echo
